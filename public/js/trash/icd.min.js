/*!
keleborn.mail@gmail.com

(c) 2015 Anton Kosiak <keleborn.mail [at] gmail.com>
Dual licenced under the MIT license or GPLv3. See https://raw.github.com/Stuk/jszip/master/LICENSE.markdown.

JSZip uses the library ICD of World Health Organization under the MIT license :
https://who.com
*/
function getJsonFile(e){var n=null,t=new XMLHttpRequest;t.open("GET","json/"+e+".json",!1),t.onreadystatechange=function(){4===t.readyState&&(200===t.status||0==t.status)&&(n=t.responseText)},t.send(null);var o=JSON.parse(n);return o}function getLang(e){var n=new XMLHttpRequest;n.open("GET","lang/"+e+".json",!1),n.onreadystatechange=function(){if(4===n.readyState)if(200===n.status||0==n.status){var e=n.responseText;Lang.text=JSON.parse(e),angular.module("multiLang",[]).controller("TranslateController",function($scope){$scope.ml=Lang.text})}else console.log(n);else console.log(n)},n.send(null)}function slideCatalog(e){screen.width>690?$("#catalog").animate({left:-width1*e}):$("#catalog").css("left",-width1*e)}function formCatalog(e,t,o,l){switch(console.log("formCatalog"),catalog=this.find("ul"),catalog.empty(),t){case"diagnose":for(n in e)li=$("<li>"+e[n].l+"."+e[n].n1+"."+e[n].n2+" "+e[n].label+"</li>"),li.attr({"class":"element list-group-item",element:t,l:e[n].l,n1:e[n].n1,n2:e[n].n2,number:n}),catalog.append(li);break;case"nosology":for(n in e)count=ICD.count.nosology[e[n].l+e[n].n1],li=$('<li> <span class="badge pull-right">'+count+"</span>"+e[n].l+"."+e[n].n1+" "+e[n].label+"</li>"),li.attr({"class":"element list-group-item",element:t,l:e[n].l,n1:e[n].n1,number:n}),catalog.append(li);break;default:for(n in e)count=ICD.count[t][e[n].l1+e[n].n1+e[n].l2+e[n].n2],li=$('<li> <span class="badge pull-right">'+count+"</span>["+e[n].l1+"."+e[n].n1+"-"+e[n].l2+"."+e[n].n2+"] "+e[n].label+"</li>"),li.attr({"class":"element list-group-item",element:t,l1:e[n].l1,n1:e[n].n1,l2:e[n].l2,n2:e[n].n2,number:n}),catalog.append(li)}}function alphabet(){for(var e=this,n=65;91>n;n++)letter=String.fromCharCode(n),op=document.createElement("option"),op.setAttribute("value",letter),op.innerHTML=letter,e.append(op)}function searchBySelect(e){var n;if(letter=$("#letter").val(),number1=$("#number1a").val()+""+$("#number1b").val(),"nosologies"==e){nos=ICD.nosologies;for(i in ICD.nosologies)ICD.nosologies[i].l==letter&&ICD.nosologies[i].n1==number1&&(n=ICD.nosologies[i].l+"."+ICD.nosologies[i].n1+". "+ICD.nosologies[i].label)}else{number2=$("#number2").val(),dis=ICD.diagnoses;for(i in dis)dis[i].l==letter&&dis[i].n1==number1&&dis[i].n2==number2&&(n=dis[i].l+"."+dis[i].n1+"."+dis[i].n2+". "+dis[i].label)}$("#select_result").text(n)}function selectValidate(){"-"==$("#letter").val()?$("#select_result").text("Choose Letter"):"-"==$("#number1a").val()||"-"==$("#number1b").val()?$("#select_result").text("Choose N1 first and second numbers"):searchBySelect("-"==$("#number2").val()?"nosologies":"diagnoses")}function Width1(){width1=$("#catalog-wrapper").width(),$(".list").width(width1-2)}function Width2(){width2=$("#autocomplete").outerWidth()}function check(){var e="check";try{return localStorage.setItem(e,e),localStorage.removeItem(e),!0}catch(n){return!1}}function loadBD(){console.log("loading BD"),console.time("count"),ICD.count=getJsonFile("count"),console.timeEnd("count"),console.time("classes"),ICD.classes=getJsonFile("classes"),console.timeEnd("classes"),console.time("blocks"),ICD.blocks=getJsonFile("blocks"),console.timeEnd("blocks"),console.time("nosologies"),ICD.nosologies=getJsonFile("nosologies"),console.timeEnd("nosologies"),console.time("diagnoses"),ICD.diagnoses=getJsonFile("diagnoses"),console.timeEnd("diagnoses")}function BD(){var e=!0;1==check()&&1==e?(local=localStorage.ICD,log("storage is available"),local?(ICD=parse(local),ICD.version&&ICD.version==version?(console.log("BD up to date, version:",version),ICD=parse(local),log(ICD),$("#localCheck").text("База даних присутня на вашому пристрої є акутальною і не потребує завантаження")):(log("old version - loading"),loadBD(),ICD.version=version,localStorage.ICD=encode(ICD),$("#localCheck").text("База даних оновлена і збережена на вашому пристрої"))):(log("no BD - loading"),loadBD(),localStorage.ICD=encode(ICD),ICD.version=version,$("#localCheck").text("База даних завантажена і збережена на вашому пристрої"))):(loadBD(),$("#localCheck").text("Ваш браузер чи пристрій не підтримує збереження даних"));$("#localCheck").append("\n\r(v.", version,")");}function loadLang(e){angular.module("multiLang",[]).controller("TranslateController",function($scope,$http){$http.get("lang/"+e+".json").success(function(e){Lang.text=e})})}function Translate(e){var n=!0;console.log("loading Lang"),angular.module("multiLang",[]).controller("TranslateController",function($scope,$http){storage.Lang&&1==n?(Lang=parse(storage.Lang),$scope.ml=Lang.text):$http.get("lang/"+e+".json").success(function(e){Lang.text=e,storage.Lang=encode(Lang),$scope.ml=Lang.text})})}var version="0.0.7",Lang={lang:"uk",version:"0.1"},ICD={number:10,classes:[],blocks:[],diagnoses:[],lang:{}},classes=[],blocks=[],diagnoses=[],nosologies=[],width1,width2,stepCatalog=0,byID=function(e){return document.getElementById(e)},parse=function(e){return JSON.parse(e)},encode=function(e){return JSON.stringify(e)},log=function(e){return console.log(arguments)},storage=localStorage;jQuery.fn.extend({}),$(window).resize(function(){Width1(),slideCatalog(stepCatalog),Width2()}),$("select.numbers").each(function(){for(var e=0;10>e;e++){var n=document.createElement("option");n.setAttribute("value",e),n.innerHTML=e,this.appendChild(n)}}),$("#selectSearchSubmit").click(function(){selectValidate()}),$(".selDisNum").change(function(){numbers=[],letter=$("#letter").val(),number1=$("#number1a").val()+""+$("#number1b").val(),dis=ICD.diagnoses;for(i in dis)dis[i].l==letter&&dis[i].n1==number1&&numbers.push(ICD.diagnoses[i].n2);el=$("#number2"),el.find("option").remove(),op=document.createElement("option"),op.setAttribute("value","-"),op.innerHTML="-",el.append(op);for(i in numbers)op=document.createElement("option"),op.setAttribute("value",numbers[i]),op.innerHTML=numbers[i],el.append(op)}),$(".icd_select").change(function(){select_code=$("#letter").val()+"."+$("#number1a").val()+$("#number1b").val()+"."+$("#number2").val(),$("#select_code").text(select_code)}),$("body").on("click","#catalog-wrapper .backCatalog",function(){stepCatalog--,slideCatalog(stepCatalog)}),$("body").on("click","#catalog-wrapper li.element",function(){if(element=$(this).attr("element"),ind=$(this).attr("number"),newElements=[],"class"==element||"block"==element)if(l1=$(this).attr("l1"),code1=l1.charCodeAt(0),n1=$(this).attr("n1"),l2=$(this).attr("l2"),code2=l2.charCodeAt(0),n2=$(this).attr("n2"),"class"==element){for(n in ICD.blocks)char1=ICD.blocks[n].l1.charCodeAt(0),char2=ICD.blocks[n].l2.charCodeAt(0),(char1>=code1&&char2<code2||char1>=code1&&char2<=code2&&ICD.blocks[n].n1>=n1&&ICD.blocks[n].n1<=n2&&ICD.blocks[n].n2>=n1&&ICD.blocks[n].n2<=n2)&&newElements.push(ICD.blocks[n]);formCatalog.call($("#catalog2"),newElements,"block",ind)}else{for(n in ICD.nosologies)char0=ICD.nosologies[n].l.charCodeAt(0),char0>=code1&&char0<=code2&&ICD.nosologies[n].n1>=n1&&ICD.nosologies[n].n1<=n2&&newElements.push(ICD.nosologies[n]);formCatalog.call($("#catalog3"),newElements,"nosology",ind)}else{if("nosology"!=element)return;l=$(this).attr("l"),n1=$(this).attr("n1");for(n in ICD.diagnoses)ICD.diagnoses[n].l==l&&ICD.diagnoses[n].n1==n1&&newElements.push(ICD.diagnoses[n]);formCatalog.call($("#catalog4"),newElements,"diagnose",ind)}newElements.length=0,height=$(".navbar-fixed-top").height(),pos=$("#catalog").offset(),$(window).scrollTop()+height>pos.top&&$(window).scrollTop(pos.top-height),stepCatalog++,slideCatalog(stepCatalog)}),$("#tab_menu button").click(function(e){e.preventDefault(),$(this).hasClass("active")||($("#tab_menu .active").toggleClass("active"),$(this).toggleClass("active"),$("#content>.active").toggleClass("active").toggleClass("hidden-xs").toggleClass("hidden-sm"),$($(this).attr("data-id")).toggleClass("active").toggleClass("hidden-xs").toggleClass("hidden-sm"),Width1(),Width2())}),$("#changeSource button").click(function(){$("#changeSource .active").removeClass("active"),$(this).addClass("active"),source=$(this).attr("source"),ICD.all||(ICD.all=ICD.nosologies.concat(ICD.diagnoses)),$("#autocomplete").autocomplete("option","source",ICD[source])}),Translate(Lang.lang),BD(),alphabet.call($("#letter")),setTimeout(formCatalog.call($("#catalog1"),ICD.classes,"class",0),0),Width1(),Width2(),window.onload=function(){$("#localCheck").append("<br/>Ваш бразуер "+(applicationCache ? "підтримує" : "не підтримує")+" веб-додаток"); var e=0;$("#autocomplete").autocomplete({autoFocus:!0,source:ICD.diagnoses,minLength:3,focus:function(e,n){console.log("focus"),e.toElement||(pos=$(".ui-state-focus").offset(),$(window).scrollTop(pos.top-$(window).height()/2))},select:function(e,n){return item=ICD.nosologies[n.item.value],$("#result").text(n.item.n2?n.item.l+"."+n.item.n1+"."+n.item.n2+" "+n.item.label:n.item.l+"."+n.item.n1+" "+n.item.label),$("#autocomplete-id").val(n.item.l2),$("#autocomplete-description").html(n.item.n1),!1},search:function(){console.time("FastSearching")},response:function(){console.timeEnd("FastSearching"),console.time("FastDrawing")},open:function(){console.timeEnd("FastDrawing")},create:function(){$(this).data("ui-autocomplete")._renderItem=function(n,t){e++;var o;switch(e){case 0:o="success";break;case 1:o="info";break;case 2:o="warning";break;case 3:o="danger"}return o="list-group-item-"+o,3==e&&(e=0),$("<li>").append(t.label).addClass("list-group-item").addClass(o).appendTo(n)},$(this).data("ui-autocomplete")._resizeMenu=function(e,n){this.menu.element.width(width2-2)}}})};